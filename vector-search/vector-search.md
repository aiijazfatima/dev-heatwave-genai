# Perform a Vector Search

## Introduction

Using the in-built vector store and retrieval-augmented generation (RAG), you can load and query unstructured documents stored in Object Storage using natural language within the HeatWave ecosystem.

_Estimated Time:_ 10 minutes

### Objectives

In this lab, you will be guided through the following task:

- Set up a vector store.
- Perform a vector search.

### Prerequisites

- Must complete Lab 4.
- Proprierty files in Object Storage.

## Task 1: Set up a vector store

1. Create a new database and select it. You can also select any existing database.

    ```bash
    <copy>create database genai_db;</copy>
	<copy>use genai_db;</copy>
    ```

    ![Create database](./images/1-create-database.png "Create database")

2. Call the following procedure to create a schema that is used for task management.

    ```bash
    <copy>select mysql_task_management_ensure_schema();</copy>
    ```

    ![Call procedure](./images/2-call-procedure.png "Call procedure")

3. Click **Reload Database Information** to view the mysql_task_management schema

    ![Reload Database Information](./images/3-reload-database-information.png "Reload Database Information")

4. Ingest the file from the Object Storage, create vector embeddings, and load the vector embeddings into HeatWave:

    ```bash
    <copy>call sys.vector_store_load('oci://<BucketName>@<Namespace>/<Path>/<Filename>','{"table_name": "<EmbeddingsTableName>"}');</copy>
    ```
    Replace the following:

    - BucketName: the OCI Object Storage bucket name.
    - Namespace: the name of the Object Storage bucket namespace.
    - Path: path to the folder that contains the source file.
    - Filename: the filename with the file extension.
    - EmbeddingsTableName: the name you want for the vector embeddings table.
    
    ```bash
    <copy>call sys.vector_store_load('oci://vectorsearch@axoumfbmk7ld/heatwave/heatwave-en.pdf', '{"table_name": "demo_embedding"}');</copy>
    ```
5. After the task is completed, verify that embeddings are loaded in the vector embeddings table:

    ```bash
    <copy>select count(*) from <EmbeddingsTableName>;</copy>
    ```
    For example:
    ```bash
    <copy>select count(*) from demo_embeddings; </copy>
    ```

If you see a numerical value in the output, your embeddings are successfully loaded in the table.

## Task 2: Perform a vector search

HeatWave retrieves content from the vector store and provide that as context to the LLM. This process is called as retrieval-augmented generation or RAG. This helps the LLM to produce more relevant and accurate results for your queries.

1. Load the LLM in HeatWave.

    ```bash
    <copy>call sys.ML_MODEL_LOAD('LLMModel', NULL);</copy>
    ```

    Replace LLMModel with the name of the LLM model that you want to use. The available models are: mistral-7b-instruct-v1 and llama2-7b-v1.

    For example:

    ```bash
    <copy>call sys.ML_MODEL_LOAD('mistral-7b-instruct-v1', NULL);</copy>
    ```

2. Specify the table for retrieving the vector embeddings, set the @options session variable.

    ```bash
    <copy>set @options = JSON_OBJECT("vector_store", JSON_ARRAY("DBName.EmbeddingsTableName"));</copy>
    ```

    For example:

    ```bash
    <copy>set @options = JSON_OBJECT("vector_store", JSON_ARRAY("demo_db.demo_embeddings"));</copy>
    ```

3. Define your natural language query, set the session @query variable:

    ```bash
    <copy>set @query="AddYourQuery";</copy>
    ```
    
    Replace AddYourQuery with your natural language query.

    For example:

    ```bash
    <copy>set @query="What is AutoML?";</copy>
    ```

4. Retrieve the augmented prompt, use the ML_RAG routine.

    ```bash
    <copy>call sys.ML_RAG(@query,@output,@options);</copy>
    ```

5. Print the output:

    ```bash
    <copy>select JSON_PRETTY(@output);</copy>
    ```
    
    Text-based content that is generated by the LLM in response to your query is printed as output. The output generated by RAG is comprised of two parts:

    - The text section contains the text-based content generated by the LLM as a response for your query.

    - The citations section shows the segments and documents it referred to as context.

The output looks similar to the following:

```bash
"text": " AutoML is a machine learning technique that automates the process
of selecting, training, and evaluating machine learning models. It involves
using algorithms and techniques to automatically identify the best model
for a given dataset and optimize its hyperparameters without requiring manual
intervention from data analysts or ML practitioners. AutoML can be used in
various stages of the machine learning pipeline, including data preprocessing,
feature engineering, model selection, hyperparameter tuning,
and model evaluation.",
"citations": [
  {
    "segment": "Oracle AutoML also produces high quality models very efficiently,
    which is achieved through a scalable design and intelligent choices that
    reduce trials at each stage in the pipeline.\n Scalable design: The Oracle
    AutoML pipeline is able to exploit both HeatWave internode and intranode
    parallelism, which improves scalability and reduces runtime.",
    "distance": 0.4262576103210449,
    "document_name": "https://objectstorage.Region.oraclecloud.com/n/Namespace/b/BucketName/o/Path/Filename"
  },
  {
    "segment": "The HeatWave AutoML ML_TRAIN routine leverages Oracle AutoML
    technology to automate the process of training a machine learning model.
    Oracle AutoML replaces the laborious and time consuming tasks of the data
    analyst whose workflow is as follows:\n1. Selecting a model from a large
    number of viable candidate models.\n2.\n99",
    "distance": 0.4311879277229309,
    "document_name": " https://objectstorage. Region.oraclecloud.com/n/Namespace/b/BucketName/o/Path/Filename"
  },
  {
    "segment": "3.1 HeatWave AutoML Features HeatWave AutoML makes it easy to
    use machine learning, whether you are a novice user or an experienced ML
    practitioner. You provide the data, and HeatWave AutoML analyzes the
    characteristics of the data and creates an optimized machine learning model
    that you can use to generate predictions and explanations.",
    "distance": 0.4441382884979248,
    "document_name": "https://objectstorage. Region.oraclecloud.com/n/Namespace/b/BucketName/o/Path/Filename"
  }
],
"vector_store": [
  "demo_db.demo_embeddings"
]
```
## Learn More

- [HeatWave User Guide](https://dev.mysql.com/doc/heatwave/en/)

- [HeatWave on OCI User Guide](https://docs.oracle.com/en-us/iaas/mysql-database/index.html)

- [MySQL Documentation](https://dev.mysql.com/)


## Acknowledgements

- **Author** - Aijaz Fatima, Product Manager
- **Contributors** - Mandy Pang, Senior Principal Product Manager, Aijaz Fatima, Product Manager
- **Last Updated By/Date** - Aijaz Fatima, Product Manager, August 2024